{% extends "base.html" %}
{% block content %}
<style>
    .setting-card { background: #fff; border-radius: 12px; border: 1px solid #eee; transition: 0.2s; }
    .setting-card:hover { border-color: #2196F3; box-shadow: 0 5px 15px rgba(33, 150, 243, 0.1); }
    .icon-wrap { width: 50px; height: 50px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
</style>

<div class="row mb-4">
    <div class="col-12">
        <h3 class="fw-bold">Cấu hình Ngưỡng (Thresholds)</h3>
        <p class="text-muted">Thiết lập các giới hạn để hệ thống tự động cảnh báo hoặc xử lý</p>
    </div>
</div>

<div class="card border-0 shadow-sm mb-4 p-3 bg-white rounded-3">
    <div class="d-flex align-items-center">
        <i class="fas fa-microchip fs-4 text-secondary me-3"></i>
        <select class="form-select border-0 bg-light fw-bold" id="selectDev">
            </select>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-6 col-lg-4">
        <div class="card setting-card p-4 h-100">
            <div class="d-flex align-items-center mb-3">
                <div class="icon-wrap bg-danger bg-opacity-10 text-danger me-3"><i class="fas fa-smog"></i></div>
                <h6 class="fw-bold mb-0">Cảm biến Bụi PM2.5</h6>
            </div>
            <p class="text-muted small">Kích hoạt chế độ vệ sinh nếu bụi vượt ngưỡng.</p>
            <div class="mt-auto">
                <label class="form-label small fw-bold">Ngưỡng Tối Đa (Max)</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="pm25_max" placeholder="50">
                    <button class="btn btn-danger" onclick="save('pm25_max', '#pm25_max')">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 col-lg-4">
        <div class="card setting-card p-4 h-100">
            <div class="d-flex align-items-center mb-3">
                <div class="icon-wrap bg-success bg-opacity-10 text-success me-3"><i class="fas fa-battery-half"></i></div>
                <h6 class="fw-bold mb-0">Dung lượng Pin</h6>
            </div>
            <p class="text-muted small">Cảnh báo khi dung lượng pin xuống thấp.</p>
            <div class="mt-auto">
                <label class="form-label small fw-bold">Ngưỡng Tối Thiểu (Min)</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="bat_min" placeholder="20">
                    <button class="btn btn-success" onclick="save('battery_min', '#bat_min')">Lưu</button>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 col-lg-4">
        <div class="card setting-card p-4 h-100">
            <div class="d-flex align-items-center mb-3">
                <div class="icon-wrap bg-warning bg-opacity-10 text-warning me-3"><i class="fas fa-thermometer-high"></i></div>
                <h6 class="fw-bold mb-0">Nhiệt độ Tấm pin</h6>
            </div>
            <p class="text-muted small">Cảnh báo quá nhiệt để bảo vệ hệ thống.</p>
            <div class="mt-auto">
                <label class="form-label small fw-bold">Ngưỡng Tối Đa (Max)</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="temp_max" placeholder="60">
                    <button class="btn btn-warning" onclick="save('temp_max', '#temp_max')">Lưu</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="liveToast" class="toast align-items-center text-white bg-primary border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body" id="toast-msg">Hello, world! This is a toast message.</div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    function save(param, selector) {
        var val = $(selector).val();
        var dev = $('#selectDev').val();
        if(!val) return alert("Nhập giá trị!");

        $.ajax({
            url: '/api/threshold', type: 'POST', contentType: 'application/json',
            data: JSON.stringify({ "device_eui": dev, "param_name": param, "max_val": val, "min_val": val }), // Tùy logic backend
            success: function() { showToast("Đã lưu thành công!"); },
            error: function() { showToast("Lỗi khi lưu!"); }
        });
    }

    function showToast(msg) {
        $('#toast-msg').text(msg);
        new bootstrap.Toast(document.getElementById('liveToast')).show();
    }

    // Load devices
    $.getJSON('/api/get-stats', function(data) {
        let opts = '';
        data.devices.forEach(d => opts += `<option value="${d.device_eui}">${d.name} (${d.device_eui})</option>`);
        $('#selectDev').html(opts);
    });
</script>
{% endblock %}