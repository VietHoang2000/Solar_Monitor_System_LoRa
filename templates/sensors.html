{% extends "base.html" %}

{% block content %}
<style>
    /* --- STYLE CHO WIDGETS --- */
    .widget-card { background: #fff; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s; border: none; height: 100%; }
    .widget-card:hover { transform: translateY(-3px); box-shadow: 0 8px 12px rgba(0,0,0,0.1); }
    .widget-icon { width: 50px; height: 50px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 24px; color: white; }
    .widget-value { font-size: 28px; font-weight: 700; color: #2c3e50; }
    .widget-label { font-size: 13px; text-transform: uppercase; color: #95a5a6; letter-spacing: 1px; }
    
    /* --- STYLE CHO GAUGES --- */
    .gauge-container { position: relative; height: 150px; width: 100%; display: flex; justify-content: center; }
    .gauge-value { position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%); font-size: 20px; font-weight: bold; color: #34495e; }
    
    /* --- STYLE CHO SIGNAL BARS --- */
    .signal-bars { display: flex; align-items: flex-end; height: 50px; gap: 4px; }
    .bar { width: 10px; background-color: #e0e0e0; border-radius: 2px; transition: all 0.3s; }
    .bar-1 { height: 20%; } .bar-2 { height: 40%; } .bar-3 { height: 60%; } .bar-4 { height: 80%; } .bar-5 { height: 100%; }
    .signal-good .bar.active { background-color: #2ecc71; }
    .signal-fair .bar.active { background-color: #f1c40f; }
    .signal-bad .bar.active { background-color: #e74c3c; }
    
    /* --- STYLE CHO TAB NAV --- */
    .nav-tabs .nav-link { color: #495057; font-weight: 600; border: none; border-bottom: 3px solid transparent; }
    .nav-tabs .nav-link.active { color: #0d6efd; border-bottom: 3px solid #0d6efd; background: transparent; }
    .nav-tabs .nav-link:hover { border-bottom: 3px solid #e9ecef; }
</style>

<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="card widget-card p-3">
            <div class="d-flex align-items-center">
                <div class="widget-icon bg-primary shadow-sm"><i class="fas fa-bolt"></i></div>
                <div class="ms-3">
                    <div class="widget-label">Điện áp Bus</div>
                    <div class="widget-value"><span id="val_volt">--</span> <small class="fs-6 text-muted">V</small></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card widget-card p-3">
            <div class="d-flex align-items-center">
                <div class="widget-icon bg-info shadow-sm"><i class="fas fa-wave-square"></i></div>
                <div class="ms-3">
                    <div class="widget-label">Dòng điện</div>
                    <div class="widget-value"><span id="val_amp">--</span> <small class="fs-6 text-muted">A</small></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card widget-card p-3">
            <div class="d-flex align-items-center">
                <div class="widget-icon bg-warning shadow-sm"><i class="fas fa-lightbulb"></i></div>
                <div class="ms-3">
                    <div class="widget-label">Công suất</div>
                    <div class="widget-value"><span id="val_power">--</span> <small class="fs-6 text-muted">W</small></div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card widget-card p-3">
            <div class="d-flex align-items-center">
                <div class="widget-icon bg-success shadow-sm"><i class="fas fa-leaf"></i></div>
                <div class="ms-3">
                    <div class="widget-label">Hiệu suất</div>
                    <div class="widget-value"><span id="val_eff">--</span> <small class="fs-6 text-muted">%</small></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-4">
        <div class="card widget-card">
            <div class="card-header bg-white fw-bold border-0 pt-3 ps-3"><i class="fas fa-tachometer-alt"></i> Giám sát Môi trường</div>
            <div class="card-body">
                <div class="row">
                    <div class="col-6 text-center mb-3">
                        <div class="gauge-container">
                            <canvas id="gaugeBat"></canvas>
                            <div class="gauge-value" id="lbl_bat">--%</div>
                        </div>
                        <small class="text-muted fw-bold">Dung lượng Pin</small>
                    </div>
                    <div class="col-6 text-center mb-3">
                        <div class="gauge-container">
                            <canvas id="gaugePm25"></canvas>
                            <div class="gauge-value" id="lbl_pm25">--</div>
                        </div>
                        <small class="text-muted fw-bold">Bụi PM2.5</small>
                    </div>
                    <div class="col-12 mt-2 px-3">
                        <div class="d-flex justify-content-between mb-1">
                            <small><i class="fas fa-thermometer-half text-danger"></i> Nhiệt độ</small>
                            <small class="fw-bold" id="txt_temp">-- °C</small>
                        </div>
                        <div class="progress mb-3" style="height: 8px;">
                            <div class="progress-bar bg-danger" id="prog_temp" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="d-flex justify-content-between mb-1">
                            <small><i class="fas fa-tint text-primary"></i> Độ ẩm</small>
                            <small class="fw-bold" id="txt_hum">-- %</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-primary" id="prog_hum" role="progressbar" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div class="card widget-card h-100">
            <div class="card-header bg-white border-0 pt-3">
                <ul class="nav nav-tabs card-header-tabs" id="mainTab" role="tablist">
                    <li class="nav-item">
                        <button class="nav-link active" id="chart-tab" data-bs-toggle="tab" data-bs-target="#tab-chart" type="button"><i class="fas fa-chart-line"></i> Phân tích</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="raw-tab" data-bs-toggle="tab" data-bs-target="#tab-raw" type="button"><i class="fas fa-table"></i> Dữ liệu thô</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" id="signal-tab" data-bs-toggle="tab" data-bs-target="#tab-signal" type="button"><i class="fas fa-wifi"></i> Tín hiệu</button>
                    </li>
                </ul>
            </div>
            
            <div class="card-body">
                <div class="tab-content" id="mainTabContent">
                    
                    <div class="tab-pane fade show active" id="tab-chart">
                        <div class="d-flex justify-content-end mb-2">
                            <div class="btn-group btn-group-sm">
                                <input type="radio" class="btn-check" name="chartOpt" id="optPower" checked onclick="toggleChart('power')">
                                <label class="btn btn-outline-primary" for="optPower">Điện năng</label>
                                <input type="radio" class="btn-check" name="chartOpt" id="optEnv" onclick="toggleChart('env')">
                                <label class="btn btn-outline-success" for="optEnv">Môi trường</label>
                            </div>
                        </div>
                        <div style="height: 300px; width: 100%;">
                            <canvas id="mainChart"></canvas>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="tab-raw">
                        <div class="table-responsive" style="max-height: 320px;">
                            <table class="table table-striped table-hover small text-center align-middle">
                                <thead class="table-dark sticky-top">
                                    <tr><th>Thời gian</th><th>Volt (V)</th><th>Amp (A)</th><th>Watt (W)</th><th>Temp</th><th>Hum</th><th>PM2.5</th></tr>
                                </thead>
                                <tbody id="raw_table_body"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="tab-signal">
                        <div class="row g-3">
                            <div class="col-md-4 border-end">
                                <div class="text-center mt-3">
                                    <h6 class="text-muted fw-bold">KẾT NỐI LORAWAN</h6>
                                    <div id="signal_viz" class="signal-bars justify-content-center mb-2 mt-3">
                                        <div class="bar bar-1"></div><div class="bar bar-2"></div><div class="bar bar-3"></div><div class="bar bar-4"></div><div class="bar bar-5"></div>
                                    </div>
                                    <h5 class="fw-bold" id="txt_signal_status">Đang tải...</h5>
                                    
                                    <div class="row mt-4">
                                        <div class="col-6">
                                            <div class="h4 text-primary fw-bold mb-0" id="val_rssi">--</div>
                                            <small class="text-muted">RSSI</small>
                                        </div>
                                        <div class="col-6">
                                            <div class="h4 text-info fw-bold mb-0" id="val_snr">--</div>
                                            <small class="text-muted">SNR</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-8">
                                <div style="height: 180px; width: 100%;">
                                    <canvas id="signalChart"></canvas>
                                </div>
                                <div class="mt-3">
                                    <h6 class="small fw-bold text-muted">Packet Log (5 gói gần nhất)</h6>
                                    <table class="table table-sm table-bordered text-center small mb-0">
                                        <thead class="table-light"><tr><th>ID</th><th>F-Cnt</th><th>RSSI</th><th>SNR</th><th>Time</th></tr></thead>
                                        <tbody id="signal_mini_log"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    Chart.defaults.font.family = "'Segoe UI', sans-serif";

    // --- 1. KHỞI TẠO CÁC CHART ---
    // Main Chart
    const mainChart = new Chart(document.getElementById('mainChart').getContext('2d'), {
        type: 'line', data: { labels: [], datasets: [] },
        options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { position: 'top' } }, scales: { y: { beginAtZero: true } } }
    });

    // Signal Chart
    const signalChart = new Chart(document.getElementById('signalChart').getContext('2d'), {
        type: 'line', data: { labels: [], datasets: [] },
        options: { 
            responsive: true, maintainAspectRatio: false, 
            plugins: { legend: { display: false }, title: { display: true, text: 'Biểu đồ RSSI & SNR' } },
            scales: { y: { type: 'linear', position: 'left' }, y1: { type: 'linear', position: 'right', grid: {drawOnChartArea: false} } } 
        }
    });

    // Gauges (Battery & PM2.5)
    const gaugeOpts = { plugins: { legend: { display: false }, tooltip: { enabled: false } }, rotation: -90, circumference: 180, cutout: '75%' };
    const gaugeBat = new Chart(document.getElementById('gaugeBat'), { type: 'doughnut', data: { datasets: [{ data: [0, 100], backgroundColor: ['#2ecc71', '#ecf0f1'], borderWidth: 0 }] }, options: gaugeOpts });
    const gaugePm25 = new Chart(document.getElementById('gaugePm25'), { type: 'doughnut', data: { datasets: [{ data: [0, 100], backgroundColor: ['#e74c3c', '#ecf0f1'], borderWidth: 0 }] }, options: gaugeOpts });

    // --- 2. LOGIC CẬP NHẬT DỮ LIỆU ---
    let historyData = [];
    let currentMode = 'power';

    function updateAllTabs() {
        // A. Lấy dữ liệu cảm biến (Cho Widget, Chart chính, Bảng thô)
        $.getJSON('/api/get-history?limit=30', function(data) {
            if(data.length > 0) {
                historyData = data;
                let last = data[data.length-1];

                // Update Widgets
                $('#val_volt').text(last.bus_voltage.toFixed(2));
                $('#val_amp').text(last.current_A.toFixed(3));
                $('#val_power').text(last.power_W.toFixed(2));
                $('#val_eff').text(last.solar_eff.toFixed(1));
                
                // Update Progress & Gauges
                $('#txt_temp').text(last.temp_c + ' °C'); $('#prog_temp').css('width', Math.min(last.temp_c, 100) + '%');
                $('#txt_hum').text(last.humidity + ' %'); $('#prog_hum').css('width', Math.min(last.humidity, 100) + '%');
                updateGauge(gaugeBat, last.battery_pct, '#2ecc71'); $('#lbl_bat').text(last.battery_pct.toFixed(0) + '%');
                updateGauge(gaugePm25, last.pm25, last.pm25 > 50 ? '#e74c3c' : '#3498db'); $('#lbl_pm25').text(last.pm25.toFixed(0));

                // Update Main Chart & Table
                renderMainChart();
                renderRawTable(data);
            }
        });

        // B. Lấy dữ liệu tín hiệu (Cho Tab Signal)
        $.getJSON('/api/get-signal-history?limit=20', function(data) {
            if(data.length > 0) {
                let last = data[data.length-1];
                
                // Số liệu
                $('#val_rssi').text(last.rssi);
                $('#val_snr').text(last.snr.toFixed(1));

                // Visual Bars Logic
                let rssi = last.rssi;
                let bars = 1; let status = "Yếu"; let colorClass = "signal-bad";
                if(rssi > -65) { bars=5; status="Tuyệt vời"; colorClass="signal-good"; }
                else if(rssi > -80) { bars=4; status="Tốt"; colorClass="signal-good"; }
                else if(rssi > -100) { bars=3; status="TB"; colorClass="signal-fair"; }
                else if(rssi > -115) { bars=2; status="Kém"; colorClass="signal-bad"; }

                $('#txt_signal_status').text(status);
                $('#signal_viz').removeClass('signal-good signal-fair signal-bad').addClass(colorClass);
                $('#signal_viz .bar').removeClass('active');
                for(let i=1; i<=bars; i++) $(`#signal_viz .bar-${i}`).addClass('active');

                // Signal Chart
                let labels = data.map(d => new Date(d.created_at || d.received_at).toLocaleTimeString());
                signalChart.data.labels = labels;
                signalChart.data.datasets = [
                    { label: 'RSSI', data: data.map(d => d.rssi), borderColor: '#3498db', tension: 0.3, yAxisID: 'y' },
                    { label: 'SNR', data: data.map(d => d.snr), borderColor: '#e67e22', tension: 0.3, yAxisID: 'y1' }
                ];
                signalChart.update('none');

                // Mini Log Table
                let logRows = '';
                [...data].reverse().slice(0, 5).forEach(d => {
                    logRows += `<tr><td>${d.id}</td><td>${d.f_cnt}</td><td>${d.rssi}</td><td>${d.snr}</td><td>${new Date(d.created_at || d.received_at).toLocaleTimeString()}</td></tr>`;
                });
                $('#signal_mini_log').html(logRows);
            }
        });
    }

    // --- HELPER FUNCTIONS ---
    function updateGauge(chart, val, color) {
        chart.data.datasets[0].data = [val, 100 - val];
        chart.data.datasets[0].backgroundColor[0] = color;
        chart.update();
    }

    function renderMainChart() {
        let labels = historyData.map(d => new Date(d.measured_at).toLocaleTimeString());
        if(currentMode === 'power') {
            mainChart.data.labels = labels;
            mainChart.data.datasets = [
                { label: 'Power (W)', data: historyData.map(d=>d.power_W), borderColor: '#f1c40f', backgroundColor: 'rgba(241,196,15,0.1)', fill: true },
                { label: 'Volt (V)', data: historyData.map(d=>d.bus_voltage), borderColor: '#3498db' }
            ];
        } else {
            mainChart.data.labels = labels;
            mainChart.data.datasets = [
                { label: 'Temp (°C)', data: historyData.map(d=>d.temp_c), borderColor: '#e74c3c', backgroundColor: 'rgba(231,76,60,0.1)', fill: true },
                { label: 'Hum (%)', data: historyData.map(d=>d.humidity), borderColor: '#3498db' }
            ];
        }
        mainChart.update('none');
    }

    function renderRawTable(data) {
        let rows = '';
        [...data].reverse().forEach(d => {
            rows += `<tr><td>${new Date(d.measured_at).toLocaleTimeString()}</td><td>${d.bus_voltage}</td><td>${d.current_A}</td><td>${d.power_W}</td><td>${d.temp_c}</td><td>${d.humidity}</td><td>${d.pm25}</td></tr>`;
        });
        $('#raw_table_body').html(rows);
    }

    function toggleChart(mode) { currentMode = mode; renderMainChart(); }

    $(document).ready(function() {
        updateAllTabs();
        setInterval(updateAllTabs, 3000);
    });
</script>
{% endblock %}